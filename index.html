<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GDQP Quiz App</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="min-h-screen flex flex-col bg-gray-100 font-sans">
    <div class="container mx-auto p-4 pb-16 flex-grow">
        <!-- User Input Popup -->
        <div id="user-popup" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white p-6 rounded shadow-xl max-w-md w-full text-center">
                <h2 class="text-2xl font-bold mb-4">Enter Your Name</h2>
                <input id="username-input" type="text" class="border p-2 w-full mb-4" placeholder="Your name" />
                <button onclick="startApp()"
                    class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Start</button>
            </div>
        </div>

        <!-- Course/Topic Selection -->
        <div id="course-selection" class="mb-8">
            <h1 class="text-3xl font-bold mb-4">Select a Topic: GDQP & AN HP2</h1>
            <div id="topics" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4"></div>
        </div>

        <!-- Quiz Section -->
        <div id="quiz-section" class="hidden">
            <h1 id="quiz-title" class="text-3xl font-bold mb-4"></h1>
            <button id="back-to-topics-btn" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Back to
                Topics</button>
            <div id="score" class="mb-4 text-lg">Score: 0 / 0</div>
            <!-- Progress Bar -->
            <div class="mb-4">
                <div class="w-full bg-gray-200 rounded-full h-4">
                    <div id="progress-bar" class="bg-blue-500 h-4 rounded-full" style="width: 0%"></div>
                </div>
                <div class="text-sm text-center mt-1" id="progress-text">0 / 0</div>
            </div>
            <div id="question" class="mb-4 text-xl"></div>
            <div id="options" class="space-y-2"></div>
            <div id="feedback" class="mt-4 hidden"></div>
            <div class="mt-4 flex space-x-4">
                <button id="next-btn"
                    class="bg-blue-500 text-white px-4 py-2 rounded hidden hover:bg-blue-600">Next</button>
            </div>
        </div>
    </div>

    <!-- Completion Popup -->
    <div id="completion-popup"
        class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded shadow-xl max-w-md w-full text-center">
            <h2 class="text-2xl font-bold text-green-600 mb-4">ðŸŽ‰ Quiz Completed!</h2>
            <p id="final-score-text" class="text-lg mb-2"></p>
            <p id="completion-time" class="text-sm text-gray-600 mb-4"></p>
            <button onclick="closePopup()"
                class="mt-2 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Close</button>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white text-center py-4">
        <p class="text-sm">&copy; 2025 by DatDev. All rights reserved.</p>
    </footer>



    <script>
        let username = "";
        let startTime = null;
        let quizData = {};
        let currentTopic = null;
        let questions = [];
        let currentQuestionIndex = 0;
        let score = 0;

        function startApp() {
            const input = document.getElementById('username-input').value.trim();
            if (input === '') {
                alert("Please enter your name.");
                return;
            }
            username = input;
            document.getElementById('user-popup').classList.add('hidden');
        }

        // Fetch quiz data from JSON file
        async function loadQuizData() {
            try {
                const response = await fetch('quizData.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                quizData = await response.json();
                loadTopics();
            } catch (error) {
                console.error('Error loading quiz data:', error);
                const topicsDiv = document.getElementById('topics');
                topicsDiv.innerHTML = '<p class="text-red-600">Failed to load quiz data. Please check if quizData.json exists.</p>';
            }
        }

        // Shuffle array function
        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // Load topics
        function loadTopics() {
            const topicsDiv = document.getElementById('topics');
            topicsDiv.innerHTML = ''; // Clear existing topics
            Object.keys(quizData).forEach(topic => {
                const button = document.createElement('button');
                button.className = 'bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600';
                button.textContent = topic;
                button.onclick = () => startQuiz(topic);
                topicsDiv.appendChild(button);
            });
        }

        // Start quiz for selected topic
        function startQuiz(topic) {
            currentTopic = topic;
            questions = shuffle([...quizData[topic]]);
            currentQuestionIndex = 0;
            score = 0;
            startTime = new Date();

            document.getElementById('course-selection').classList.add('hidden');
            document.getElementById('quiz-section').classList.remove('hidden');
            document.getElementById('quiz-title').textContent = `Quiz: ${topic}`;
            document.getElementById('score').textContent = `Score: ${score} / ${questions.length}`;
            document.getElementById('back-to-topics-btn').classList.remove('hidden');
            updateProgressBar();
            loadQuestion();
        }

        // Update progress bar
        function updateProgressBar() {
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            const progress = questions.length ? ((currentQuestionIndex + 1) / questions.length) * 100 : 0;
            progressBar.style.width = `${progress}%`;
            progressText.textContent = `${currentQuestionIndex + 1} / ${questions.length}`;
        }

        // Load current question
        function loadQuestion() {
            const questionData = questions[currentQuestionIndex];
            document.getElementById('question').textContent = questionData.question;

            const shuffledOptions = shuffle([...questionData.options]);

            const optionsDiv = document.getElementById('options');
            optionsDiv.innerHTML = '';
            shuffledOptions.forEach(option => {
                const button = document.createElement('button');
                button.className = 'w-full bg-gray-200 text-left px-4 py-2 rounded hover:bg-gray-300';
                button.textContent = option;
                button.onclick = () => checkAnswer(option, questionData.correct);
                optionsDiv.appendChild(button);
            });

            document.getElementById('feedback').classList.add('hidden');
            document.getElementById('next-btn').classList.add('hidden');
            updateProgressBar();
        }

        // Check answer
        function checkAnswer(selected, correct) {
            const feedbackDiv = document.getElementById('feedback');
            const nextBtn = document.getElementById('next-btn');
            feedbackDiv.classList.remove('hidden');

            if (selected === correct) {
                score++;
                feedbackDiv.className = 'mt-4 text-green-600';
                feedbackDiv.textContent = 'Correct!';

                const sound = document.getElementById('correct-sound');
                sound.currentTime = 0;
                sound.play();
            } else {
                feedbackDiv.className = 'mt-4 text-red-600';
                feedbackDiv.textContent = `Wrong! The correct answer is: ${correct}`;
            }

            document.getElementById('score').textContent = `Score: ${score} / ${questions.length}`;
            nextBtn.classList.remove('hidden');
            nextBtn.onclick = nextQuestion;

            document.querySelectorAll('#options button').forEach(button => {
                button.disabled = true;
                if (button.textContent === correct) {
                    button.classList.add('bg-green-200');
                } else if (button.textContent === selected) {
                    button.classList.add('bg-red-200');
                }
            });
        }

        // Load next question
        function nextQuestion() {
            currentQuestionIndex++;
            if (currentQuestionIndex < questions.length) {
                loadQuestion();
            } else {
                const endTime = new Date();
                const duration = Math.floor((endTime - startTime) / 1000);
                const minutes = Math.floor(duration / 60);
                const seconds = duration % 60;
                const timeText = minutes > 0 ? `${minutes}m ${seconds}s` : `${seconds}s`;

                document.getElementById('final-score-text').textContent = `You got ${score} out of ${questions.length} correct!`;
                document.getElementById('completion-time').textContent = `Time taken: ${timeText}`;
                document.getElementById('completion-popup').classList.remove('hidden');

                // Gá»­i email báº±ng EmailJS
                emailjs.send("service_a4iskjs", "template_cbflrcx", {
                    name: username,
                    score: score,
                    total: questions.length,
                    time: timeText,
                    topic: currentTopic
                }).then(function (response) {
                    console.log("Email sent successfully", response.status, response.text);
                }, function (error) {
                    console.error("Failed to send email:", error);
                });
            }
        }
        // Back to topics
        function backToTopics() {
            document.getElementById('quiz-section').classList.add('hidden');
            document.getElementById('course-selection').classList.remove('hidden');
            document.getElementById('question').textContent = '';
            document.getElementById('options').innerHTML = '';
            document.getElementById('feedback').classList.add('hidden');
            document.getElementById('next-btn').classList.add('hidden');
            document.getElementById('back-to-topics-btn').classList.add('hidden');
            currentQuestionIndex = 0;
            score = 0;
            questions = [];
            currentTopic = null;
        }

        function closePopup() {
            document.getElementById('completion-popup').classList.add('hidden');
            backToTopics();
        }

        // Initialize back to topics button
        document.getElementById('back-to-topics-btn').onclick = backToTopics;

        // Initialize
        loadQuizData();
    </script>

    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script>
        emailjs.init('TY1_DcQWKd6EI1wv6'); 
    </script>

    <audio id="correct-sound" src="sounds/correct.mp3" preload="auto"></audio>
</body>

</html>